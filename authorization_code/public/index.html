<!doctype html>
<html>
  <head>
    <title>Welcome to VIBEZ!</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <script type="text/javascript" src="script.js"></script>
  </head>

  <body>        <header>
    <canvas id="canvas"></canvas>
    <div class="main">
    </div>
    <audio id="audio" loop></audio>
    <div class="title">
        <h1>VIBE OUT!</h1>
    </div>
    <div class="desu">
      <h1>PLAY TUNES YOU VIBE TO!</h1>
    </div>
    <a href="title.html">
      <button class="home">
        HOME
      </button>
    </a>
    <a href="info.html">
      <button class="inform">
        INFO
      </button>
    </a>
    <a href="main.html">
        <button class="register">
            PLAY NOW!
        </button>
    </a>
    <a href="/login">
      <button class="login">
          LOGIN
      </button>
  </a>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
      window.onSpotifyWebPlaybackSDKReady = () => {
        const token = 'BQDMzfqLbNnpbtqDRNiJiYlN4WDsNbfrDl3871-HbUaN6WknZXe1F844-BRRxqA30Cv3RF5cbdM9TrpNGgl6zgVOO2rUBP6QrTSkwVaurlLhyE4gBZpVJNbuEls_Hn3NoiCIrFOYJpBojVzSNz7nlTNl7K7BMYu9qSgvtX30e5dAJWgF2nHoMBc';
        const player = new Spotify.Player({
          name: 'VIBEZ Online Player',
          getOAuthToken: cb => { cb(token); }
        });
  
        // Error handling
        player.addListener('initialization_error', ({ message }) => { console.error(message); });
        player.addListener('authentication_error', ({ message }) => { console.error(message); });
        player.addListener('account_error', ({ message }) => { console.error(message); });
        player.addListener('playback_error', ({ message }) => { console.error(message); });
  
        // Playback status updates
        player.addListener('player_state_changed', state => { console.log(state); });
  
        // Ready
        player.addListener('ready', ({ device_id }) => {
          console.log('Ready with Device ID', device_id);
        });
  
        // Not Ready
        player.addListener('not_ready', ({ device_id }) => {
          console.log('Device ID has gone offline', device_id);
        });
  
        // Connect to the player!
        player.connect();
        
  
  
        
      };
    </script>
    <input type="file" id="thefile" accept="audio/*" />
</header>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error,
            items = params.items,
            total = params.total;
            id = params.id;

        var totalplaylists;
        var userID;
        var arrTracksUri = [];
        var arrTempo = [];

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userID = response.id;
                  $.ajax({
                                url: 'https://api.spotify.com/v1/users/' + userID + '/playlists',
                                method: "POST",
                                data: JSON.stringify({
                                  name: "VIBEZTEMP",
                                  public: "false"
                                }),
                                headers: {
                                  'Authorization': 'Bearer ' + access_token,
                                  'Content-Type': 'application/json'
                                },
                                success: function(response) {
                  $.ajax({
                      url: 'https://api.spotify.com/v1/me/playlists',
                      headers: {
                        'Authorization': 'Bearer ' + access_token
                      },
                      success: function(response) {
                        totalplaylists = response.total;
                        items = response.items;
                        for(var i = 0; i < totalplaylists; i++){
                          (function (i) {
                            $.ajax({
                                url: 'https://api.spotify.com/v1/playlists/' + items[i].id + '/tracks',
                                headers: {
                                  'Authorization': 'Bearer ' + access_token
                                },
                                success: function(response) {
                                if(response.total > 0){
                                  for(var j = 0; j < response.total; j++){
                                    if(arrTracksUri.length > 0){
                                      if(response.items[j].track){
                                      if(arrTracksUri.includes(response.items[j].track.uri)!=true){
                                        arrTracksUri.push(response.items[j].track.uri);
                                    }
                                  }
                                } else {
                                      arrTracksUri.push(response.items[j].track.uri);
                                }
                              }
                            }
                            if(items[i].name == "VIBEZTEMP"){
                              $.ajax({
                                url: 'https://api.spotify.com/v1/playlists/' + items[i].id + '/tracks',
                                method: "POST",
                                data: JSON.stringify({
                                  uris: [arrTracksUri[0],arrTracksUri[1],arrTracksUri[2],arrTracksUri[3],arrTracksUri[4],arrTracksUri[5],arrTracksUri[6],arrTracksUri[7],arrTracksUri[8]],
                                }),
                                headers: {
                                  'Authorization': 'Bearer ' + access_token,
                                  'Content-Type': 'application/json'
                                },
                                success: function(response) {
                                    console.log("Works!");
                                }
                              });
                          }
                          }
                            });
                          })(i);
                        }
                      }
                    });
                  }
                              });
                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
          }
        }
      })();
    </script>
  </body>
</html>

